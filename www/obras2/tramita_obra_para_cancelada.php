<?php
set_time_limit(30000);

define('BASE_PATH_SIMEC', realpath(dirname(__FILE__) . '/../../'));

// carrega as funções gerais
include_once BASE_PATH_SIMEC . "/global/config.inc";
include_once APPRAIZ . "includes/funcoes.inc";
include_once APPRAIZ . "includes/library/simec/funcoes.inc";
include_once APPRAIZ . "includes/classes_simec.inc";
include_once APPRAIZ . "includes/simec_funcoes.inc";
require_once APPRAIZ . 'includes/workflow.php';
require_once APPRAIZ . 'www/obras2/_funcoes.php';

// CPF do administrador de sistemas
$_SESSION['usucpforigem'] 	= '00000000191';
$_SESSION['usucpf'] 		= '00000000191';

$db = new cls_banco();

$strObrid = retornaObrid();

$sql = "SELECT DISTINCT es.esdid, es.esddsc,
	(SELECT (aedid) FROM workflow.acaoestadodoc WHERE esdidorigem = es.esdid AND esdiddestino = 769 ORDER BY (aedvisivel = TRUE) DESC LIMIT 1) as aedid
FROM obras2.obras o
	INNER JOIN workflow.documento d ON d.docid = o.docid
	--INNER JOIN workflow.historicodocumento hd ON hd.docid = d.docid
	INNER JOIN workflow.estadodocumento es ON es.esdid = d.esdid
WHERE o.obrid IN ($strObrid) AND d.esdid NOT IN (769) ";

$arrDados = $db->carregar($sql);
$arrDados = $arrDados ? $arrDados : array();

$comentario = "Em atenção ao artigo 2º da Resolução nº 4, de 21 de dezembro de 2017, expedida pelo Comitê Gestor do Programa de Aceleração do Crescimento (CGPAC), visando à readequação da carteira de ativos do programa às disponibilidades orçamentárias e financeiras da União, bem como em razão da decisão emitida pelo CGPAC aos Ministérios Setoriais que somos pelo cancelamento das obras não iniciados.";

$arrRegistro = array();

foreach ($arrDados as $v) {
    
    $sql = "select DISTINCT * from(
            	SELECT DISTINCT o.obrid, d.docid, es.esdid, es.esddsc,
            		(SELECT (aedid) FROM workflow.acaoestadodoc WHERE esdidorigem = es.esdid AND esdiddestino = 769 ORDER BY (aedvisivel = TRUE) DESC LIMIT 1)
            	FROM obras2.obras o
            		INNER JOIN workflow.documento d ON d.docid = o.docid
            		--INNER JOIN workflow.historicodocumento hd ON hd.docid = d.docid
            		INNER JOIN workflow.estadodocumento es ON es.esdid = d.esdid
            	WHERE o.obrid IN ($strObrid) and es.esdid = {$v['esdid']}
            ) as foo
            where aedid = {$v['aedid']}";
    $arrEstado = $db->carregar($sql);
    $arrEstado = $arrEstado ? $arrEstado : array();
    //ver($arrDados, $arrEstado,d);
    $total = 0;
    foreach ($arrEstado as $est) {
        $arrParamWork = array('obrid' => $est['obrid']);
        if (!wf_alterarEstado($est['docid'], $v['aedid'], $comentario, $arrParamWork)) {
            $error = true;
        }
        $total++;
    }
    array_push($arrRegistro, array('esdid' => $est['esdid'],
                                    'esddsc' => $est['esddsc'],
                                    'total' => $total
                                ));
    $db->commit();
}
ver($arrRegistro);

function retornaObrid(){
    $obrid = "19106,
19324,
19671,
19726,
19883,
19888,
19984,
20070,
20115,
1010983,
1010982,
1010969,
1001926,
1004325,
1010990,
25679,
1014651,
24590,
24597,
24596,
1014588,
1009088,
24997,
24994,
24992,
24989,
24993,
1004851,
32941,
32930,
1001193,
1014593,
1012624,
32910,
32901,
32938,
32903,
32908,
32902,
32914,
32932,
32947,
32933,
32949,
32911,
32922,
32935,
32939,
32936,
1009096,
32917,
1001194,
32951,
32927,
32905,
32945,
32909,
24996,
32913,
25025,
1016878,
24397,
24398,
1012756,
25038,
32979,
32980,
32982,
32983,
32985,
32986,
32987,
32994,
32996,
32997,
32998,
1002371,
24677,
1010672,
1009275,
1001469,
1001468,
1001775,
1012786,
1001640,
1001641,
1001639,
24752,
24755,
24757,
1010979,
1010978,
1009282,
1009283,
1011118,
1016235,
1017344,
1004340,
1009286,
1006670,
1001785,
1002382,
1017329,
24311,
25066,
25065,
25068,
25067,
1010646,
25585,
25598,
1016556,
1017332,
1017102,
25359,
25357,
25356,
25358,
25360,
1001893,
25312,
25311,
25309,
1002797,
1009213,
1001187,
1001800,
1014648,
1014646,
1005040,
1015899,
29935,
29957,
29988,
29985,
29963,
29984,
29983,
31050,
29954,
29943,
29972,
29980,
29953,
29976,
29986,
29956,
29942,
29938,
29994,
29951,
29979,
29955,
29970,
29952,
29982,
29968,
29950,
31047,
29939,
29967,
29991,
29981,
31048,
31022,
1001565,
30865,
1000537,
1014862,
23341,
23304,
23324,
23312,
23316,
22552,
22497,
23332,
23320,
23331,
23328,
22894,
22932,
22928,
22945,
31421,
30002,
31415,
31873,
31876,
22895,
22906,
22912,
22898,
22918,
31871,
22937,
22955,
22956,
22963,
31414,
31395,
31392,
22972,
29997,
22904,
31869,
22925,
22971,
22850,
22905,
22849,
22911,
31872,
22943,
22915,
22930,
22903,
22942,
22868,
22931,
31398,
22940,
22959,
22986,
22953,
22951,
22964,
22957,
22952,
22876,
22862,
22985,
22892,
22936,
22881,
30001,
31422,
22909,
22870,
22893,
22916,
31399,
31418,
31424,
31409,
31419,
22997,
22859,
31420,
22987,
31394,
22934,
31403,
22924,
22923,
31416,
31412,
22878,
22879,
30004,
31426,
22851,
31552,
31879,
22861,
31553,
31171,
29996,
29995,
30008,
22989,
22865,
22863,
22875,
31423,
31408,
31554,
30000,
22990,
30005,
22992,
31393,
22978,
31551,
31877,
22980,
22981,
31874,
22979,
22970,
22977,
31555,
31402,
31556,
22968,
22692,
1006942,
1004759,
1007393,
26024,
26025,
1004605,
23050,
1014904,
1014903,
1013017,
1004767,
1007980,
1004542,
1004452,
1006767,
1017738,
1007359,
1014736,
1007510,
1016614,
1008728,
1014936,
1017879,
1008538,
1014849,
1015947,
1008924,
1017259,
1006089,
1006085,
1006088,
1006084,
1006092,
1001611,
1012780,
1001612,
1012578,
1006820,
1006816,
1012765,
1005489,
1010968,
1009060,
1012754,
1012800,
1009169,
1009115,
1012804,
1016572,
1017069,
1012763,
1012655,
1012656,
1009276,
1006815,
1012605,
1006775,
1006025,
1017094,
1009295,
1006829,
1006880,
1012609,
1009056,
1009055,
1012692,
1009090,
1012629,
1006049,
1009087,
1009074,
1012610,
1012606,
1012611,
1012607,
1012608,
1014647,
1009089,
1006050,
1009094,
1012621,
1009057,
1009097,
1012627,
1012628,
1012631,
1012625,
1009092,
1009093,
1009072,
1009091,
1012632,
1011054,
1005587,
1017349,
1017158,
1006881,
1006879,
1006882,
1006822,
1015719,
1014518,
1016569,
1016595,
1018571,
1016570,
1017337,
1016230,
1016233,
1016231";
    return $obrid;
}